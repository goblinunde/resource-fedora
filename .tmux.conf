# ==============================================================================
# Tmux ç»ˆæé…ç½®æ–‡ä»¶ (Ultimate ~/.tmux.conf)
#
# ç‰ˆæœ¬: 3.0 (é›†æˆ FZF, Popups, Lazygit, Vim-Nav)
# å‰ç¼€é”®: Ctrl + a
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. æ ¸å¿ƒåŸºç¡€è®¾ç½® (Core Settings)
# ------------------------------------------------------------------------------

# --- ç»ˆç«¯é¢œè‰²ä¸æ€§èƒ½ ---
# å¯ç”¨ 256 è‰²æ”¯æŒ
set -g default-terminal "tmux-256color"
# å¯ç”¨ True Color (24ä½çœŸå½©è‰²) æ”¯æŒï¼Œé˜²æ­¢ vim é¢œè‰²å¤±çœŸ
set-option -sa terminal-features ',xterm-256color:RGB'
set-option -sa terminal-overrides ",xterm*:Tc"
set-option -sa terminal-features ',alacritty:RGB,wezterm*:RGB'

# --- äº¤äº’ä½“éªŒ ---
# å¯ç”¨é¼ æ ‡ (ç‚¹å‡»åˆ‡æ¢é¢æ¿ã€æ‹–æ‹½è°ƒæ•´å¤§å°ã€æ»šè½®æ»šåŠ¨)
set -g mouse on
# å†å²è®°å½•è¡Œæ•° (å¢åŠ å›æ»šç¼“å†²åŒº)
set -g history-limit 50000
# æ¶ˆé™¤ Esc é”®åœ¨ Vim ä¸­çš„å»¶è¿Ÿ (æé‡è¦ï¼)
set -s escape-time 0
# å…è®¸ç»ˆç«¯åº”ç”¨æ„ŸçŸ¥ç„¦ç‚¹å˜åŒ– (å¯¹ Vim çš„ autoread å¾ˆé‡è¦)
set -g focus-events on

# --- ç´¢å¼•ä¸æ˜¾ç¤º ---
# çª—å£å’Œé¢æ¿ä» 1 å¼€å§‹ç¼–å· (ç¬¦åˆé”®ç›˜æ•°å­—é”®å¸ƒå±€)
set -g base-index 1
setw -g pane-base-index 1
# å…³é—­çª—å£åè‡ªåŠ¨é‡æ–°æ’åºç¼–å·
set -g renumber-windows on
# è‡ªåŠ¨é‡å‘½åçª—å£
setw -g automatic-rename on
# å»¶é•¿æ¶ˆæ¯æ˜¾ç¤ºæ—¶é—´ (2ç§’)
set -g display-time 2000

# ------------------------------------------------------------------------------
# 2. å¿«æ·é”®é…ç½® (Keybindings)
# ------------------------------------------------------------------------------

# --- å‰ç¼€é”® (Prefix) ---
# ä¿®æ”¹ä¸º Ctrl + a (æ›´é¡ºæ‰‹)
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# æŒ‰ä¸¤æ¬¡ Ctrl+a å¿«é€Ÿåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªçª—å£
bind-key C-a last-window

# --- é…ç½®æ–‡ä»¶é‡è½½ ---
bind r source-file ~/.tmux.conf \; display-message "ğŸš€ Config reloaded!"

# --- çª—å£ä¸é¢æ¿ç®¡ç† ---
# v = å‚ç›´åˆ†å‰² (å·¦å³åŒåˆ—) - æ–°é¢æ¿ä¿æŒå½“å‰è·¯å¾„
bind v split-window -h -c "#{pane_current_path}"
# h = æ°´å¹³åˆ†å‰² (ä¸Šä¸‹åŒè¡Œ) - æ–°é¢æ¿ä¿æŒå½“å‰è·¯å¾„
bind h split-window -v -c "#{pane_current_path}"
# c = åˆ›å»ºæ–°çª—å£ - ä¿æŒå½“å‰è·¯å¾„
bind c new-window -c "#{pane_current_path}"

# --- æ‚¨å®šåˆ¶çš„ Shell å¿«æ·é”® ---
bind b new-window -n "bash" "bash"
bind s new-window -n "zsh" "zsh"

# --- å…³é—­æ“ä½œ ---
bind x kill-pane        # å…³é—­å½“å‰é¢æ¿
bind X kill-window      # å…³é—­å½“å‰çª—å£ (Shift+x)

# --- å¯¼èˆª (Navigation) ---
# 1. é¢æ¿åˆ‡æ¢ (ä½¿ç”¨ Vim é£æ ¼ h,j,k,l)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R
# (æ³¨ï¼šå®‰è£… vim-tmux-navigator æ’ä»¶åï¼Œå¯ç›´æ¥ç”¨ Ctrl-h/j/k/l æ— ç¼åˆ‡æ¢)

# 2. çª—å£åˆ‡æ¢ (Alt + ç®­å¤´/æ•°å­—)
bind -n M-h previous-window
bind -n M-l next-window
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# 3. è°ƒæ•´é¢æ¿å¤§å° (Shift + H/J/K/L)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# 4. æœ€å¤§åŒ–/æ¢å¤é¢æ¿ (Zoom)
bind z resize-pane -Z

# ------------------------------------------------------------------------------
# 3. è¿›é˜¶åŠŸèƒ½ä¸å·¥ä½œæµ (Advanced Workflow)
# ------------------------------------------------------------------------------

# --- æµ®åŠ¨çª—å£å·¥å…· (Popup) ---
# å‰ç¼€ + g : å¼¹å‡º Lazygit (éœ€å®‰è£… lazygit)
bind g display-popup -d '#{pane_current_path}' -w90% -h90% -E lazygit

# å‰ç¼€ + t : å¼¹å‡ºä¸´æ—¶ç»ˆç«¯ (ç”¨äºä¸´æ—¶è¿è¡Œå‘½ä»¤ï¼Œç”¨å®Œå³èµ°)
bind t display-popup -d '#{pane_current_path}' -w80% -h80% -E $SHELL

# --- æ‰¹é‡æ“ä½œ ---
# å‰ç¼€ + E : åŒæ­¥æ“ä½œæ¨¡å¼ (åœ¨ä¸€ä¸ªé¢æ¿è¾“å…¥ï¼Œæ‰€æœ‰é¢æ¿åŒæ—¶æ‰§è¡Œ)
bind E setw synchronize-panes \; display "Sync mode: #{?synchronize-panes,ON,OFF}"

# ------------------------------------------------------------------------------
# 4. å¤åˆ¶æ¨¡å¼ (Copy Mode - Vi Style)
# ------------------------------------------------------------------------------
setw -g mode-keys vi

# å‰ç¼€ + [ è¿›å…¥å¤åˆ¶æ¨¡å¼
# v å¼€å§‹é€‰æ‹©ï¼Œy å¤åˆ¶ (ç”± tmux-yank æ’ä»¶æ¥ç®¡ï¼Œå¤åˆ¶åˆ°ç³»ç»Ÿå‰ªè´´æ¿)
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# ------------------------------------------------------------------------------
# 5. ç•Œé¢ç¾åŒ– (UI & Theme)
# ------------------------------------------------------------------------------

# çŠ¶æ€æ ä½ç½®
set -g status-position top
set -g status-bg '#282a36'
set -g status-fg '#f8f8f2'
set -g status-interval 1

# å·¦ä¾§ï¼šä¼šè¯åç§°
set -g status-left-length 60
set -g status-left '#[bg=#bd93f9,fg=#282a36,bold] â #S #[fg=#bd93f9,bg=#282a36]î‚° '

# ä¸­é—´ï¼šçª—å£åˆ—è¡¨
setw -g window-status-separator ''
setw -g window-status-format '#[fg=#6272a4,bg=#282a36]  #I:#W  '
setw -g window-status-current-format '#[fg=#282a36,bg=#ff79c6]î‚°#[fg=#282a36,bg=#ff79c6,bold] #I:#W #[fg=#ff79c6,bg=#282a36]î‚°'

# å³ä¾§ï¼šç³»ç»Ÿä¿¡æ¯ (ä¾èµ– tmux-cpu æ’ä»¶)
set -g status-right-length 100
set -g status-right '#[fg=#6272a4,bg=#282a36]î‚²#[fg=black,bg=#6272a4] CPU: #{cpu_percentage} î‚³ MEM: #{ram_percentage} #[fg=#ff5555,bg=#6272a4]î‚²#[fg=black,bg=#ff5555] %Y-%m-%d %H:%M '

# é¢æ¿è¾¹æ¡†é¢œè‰²
set -g pane-border-style fg='#6272a4'
set -g pane-active-border-style fg='#bd93f9'

# ------------------------------------------------------------------------------
# 6. æ’ä»¶ç®¡ç† (Plugins via TPM)
# ------------------------------------------------------------------------------

# å¿…é¡»å…ˆæ‰‹åŠ¨å…‹éš† TPM: 
# git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# --- æ ¸å¿ƒåŠŸèƒ½å¢å¼º ---
set -g @plugin 'christoomey/vim-tmux-navigator' # å®Œç¾æ•´åˆ Vim/Tmux å¯¼èˆª (Ctrl+h/j/k/l)
set -g @plugin 'tmux-plugins/tmux-resurrect'    # ä¼šè¯ä¿å­˜
set -g @plugin 'tmux-plugins/tmux-continuum'    # è‡ªåŠ¨ä¿å­˜/æ¢å¤
set -g @plugin 'tmux-plugins/tmux-yank'         # å‰ªè´´æ¿å¤åˆ¶

# --- æœç´¢ä¸æå– (FZF & Extrakto) ---
set -g @plugin 'sainnhe/tmux-fzf'               # æ¨¡ç³Šæœç´¢ Session/Window
set -g @plugin 'laktak/extrakto'                # å¿«é€Ÿæå–å±å¹•æ–‡æœ¬ (Prefix + Tab)
set -g @plugin 'tmux-plugins/tmux-open'         # æ‰“å¼€é«˜äº®é“¾æ¥

# --- çŠ¶æ€æ ç»„ä»¶ ---
set -g @plugin 'tmux-plugins/tmux-cpu'

# ------------------------------------------------------------------------------
# 7. æ’ä»¶è¯¦ç»†é…ç½® (Plugin Configs)
# ------------------------------------------------------------------------------

# --- Resurrect & Continuum ---
set -g @continuum-restore 'on'            # å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤ä¼šè¯
set -g @continuum-save-interval '10'      # æ¯10åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session' # æ¢å¤ Neovim ä¼šè¯

# --- Tmux FZF ---
# ç»‘å®šå‰ç¼€ + f å‘¼å‡º FZF èœå• (æœç´¢ä¼šè¯ã€çª—å£ç­‰)
TMUX_FZF_LAUNCH_KEY="f"

# --- Extrakto ---
# ç»‘å®šå‰ç¼€ + e å‘¼å‡ºå±å¹•æ–‡æœ¬æå–
set -g @extrakto_key 'e'

# ------------------------------------------------------------------------------
# 8. åˆå§‹åŒ–æ’ä»¶ç®¡ç†å™¨ (Keep this line at the very bottom)
# ------------------------------------------------------------------------------
run '~/.tmux/plugins/tpm/tpm'
